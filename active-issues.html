<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Active Issues - Library Management</title>
    <link rel="stylesheet" href="/frontend/css/style.css">
</head>
<body>
    <div class="chart-nav">
        <button onclick="window.location.href='index.html'" class="chart-btn">
            <i>üìä</i> Chart
        </button>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>üìö Library MS</h3>
                <p>Transactions</p>
            </div>
            <div class="user-info" id="userInfo"></div>
            <nav class="sidebar-nav">
                <a href="user-home.html"> <span>üè†</span> Home</a>
                <a href="transactions.html" class="active"> <span>üìã</span> Transactions</a>
                <a href="reports.html"> <span>üìä</span> Reports</a>
                <a href="#" id="logoutBtn"> <span>üö™</span> Logout</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Active Issues</h1>
                <div class="header-right">
                    <span id="currentDateTime"></span>
                    <button onclick="window.location.href='transactions.html'" class="btn btn-secondary" style="margin-left:15px">Back</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Currently Issued Items</h2>
                    <div>
                        <button id="refreshBtn" class="btn btn-primary">Refresh</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="color:#718096;margin-bottom:12px">Select a row (radio button in the last column) to return or extend the issue.</p>

                    <table class="table" id="issues-table">
                        <thead>
                            <tr>
                                <th>Membership No</th>
                                <th>Name</th>
                                <th>Book</th>
                                <th>Author</th>
                                <th>Serial No</th>
                                <th>Issue Date</th>
                                <th>Return Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="issues-body">
                            <!-- Active issues loaded from server -->
                        </tbody>
                    </table>

                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:16px">
                        <button id="returnBtn" class="btn btn-primary">Return Book</button>
                        <button id="extendBtn" class="btn btn-secondary">Extend Return Date</button>
                        <button id="detailsBtn" class="btn btn-view">View Details</button>
                    </div>

                    <div id="issues-error" class="error-message" style="display:none;margin-top:12px" aria-live="polite"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('currentDateTime').textContent = new Date().toLocaleString();

        const getSelected = ()=>{
            const sel = document.querySelector('input[name="selectedIssue"]:checked');
            return sel ? JSON.parse(sel.value) : null;
        };

        const errorDiv = document.getElementById('issues-error');

        document.getElementById('returnBtn').addEventListener('click', ()=>{
            errorDiv.style.display='none';
            const sel = getSelected();
            if(!sel){ errorDiv.textContent = 'Please select an issued book to return.'; errorDiv.style.display='block'; return; }
            // navigate to return-book page with details
            const q = new URLSearchParams({mem: sel.mem, name: sel.name, book: sel.book, serial: sel.serial, issueDate: sel.issueDate, returnDate: sel.returnDate});
            window.location.href = 'return-book.html?' + q.toString();
        });

        document.getElementById('extendBtn').addEventListener('click', ()=>{
            errorDiv.style.display='none';
            const sel = getSelected();
            if(!sel){ errorDiv.textContent = 'Please select an issued book to extend.'; errorDiv.style.display='block'; return; }
            const days = prompt('Enter number of days to extend (max 15):', '7');
            if(days === null) return; // cancelled
            const n = parseInt(days,10);
            if(isNaN(n) || n < 0 || n > 15){ alert('Invalid number of days. Please enter 0-15.'); return; }
            alert('Return date extended by ' + n + ' days (simulated).');
            // In a real app, send update to server here
        });

        document.getElementById('detailsBtn').addEventListener('click', ()=>{
            errorDiv.style.display='none';
            const sel = getSelected();
            if(!sel){ errorDiv.textContent = 'Please select an issued book to view details.'; errorDiv.style.display='block'; return; }
            alert('Issued to: ' + sel.name + '\nBook: ' + sel.book + '\nSerial: ' + sel.serial + '\nIssue Date: ' + sel.issueDate + '\nReturn Date: ' + sel.returnDate);
        });

        document.getElementById('refreshBtn').addEventListener('click', ()=> location.reload());

        async function loadActiveIssues(){
            const tbody = document.getElementById('issues-body');
            tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
            try{
                const token = localStorage.getItem('token');
                const res = await fetch('/api/issue/active', { headers: token ? { 'x-auth-token': token } : {} });
                if(!res.ok) throw new Error('Failed to load active issues');
                const issues = await res.json();
                if(!issues.length){ tbody.innerHTML = '<tr><td colspan="8">No active issues</td></tr>'; return; }
                tbody.innerHTML = '';
                issues.forEach(i=>{
                    const tr = document.createElement('tr');
                    const v = { mem: i.membershipId, name: i.memberName, book: i.itemName, serial: i.serialNo, issueDate: (i.issueDate||'').split && i.issueDate.split('T') ? i.issueDate.split('T')[0] : '', returnDate: (i.returnDate||'').split && i.returnDate.split('T') ? i.returnDate.split('T')[0] : '' };
                    tr.innerHTML = `
                        <td>${i.membershipId}</td>
                        <td>${i.memberName}</td>
                        <td>${i.itemName}</td>
                        <td>${i.authorName}</td>
                        <td>${i.serialNo}</td>
                        <td>${v.issueDate}</td>
                        <td>${v.returnDate}</td>
                        <td><input type="radio" name="selectedIssue" value='${JSON.stringify(v)}'></td>
                    `;
                    tbody.appendChild(tr);
                });
            }catch(err){ console.error('loadActiveIssues error',err); tbody.innerHTML = '<tr><td colspan="8">Error loading active issues</td></tr>'; }
        }

        // load active issues on page load
        loadActiveIssues();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overdue Returns - Library Management System</title>
    <link rel="stylesheet" href="/frontend/css/style.css">
    <style>
        .overdue-highlight {
            background: #fff5f5 !important;
        }
        
        .fine-amount {
            color: #e53e3e;
            font-weight: 700;
            font-size: 16px;
        }
        
        .days-overdue {
            background: #f56565;
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
        }
        
        .summary-card .stat-icon,
        .summary-card .stat-info h3,
        .summary-card .stat-info p {
            color: white;
        }
        
        .btn-collect-fine {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-collect-fine:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }
        
        .fine-calculated {
            background: #feebc8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="chart-nav">
        <button onclick="window.location.href='index.html'" class="chart-btn">
            <i>üìä</i> Chart
        </button>
    </div>
    
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>üìö Library MS</h3>
                <p id="userRole">User</p>
            </div>
            <div class="user-info" id="userInfo"></div>
            <nav class="sidebar-nav">
                <a href="#" id="homeLink"><span>üè†</span> Home</a>
                <a href="transactions.html"><span>üìã</span> Transactions</a>
                <a href="reports.html" class="active"><span>üìä</span> Reports</a>
                <a href="#" id="logoutBtn"><span>üö™</span> Logout</a>
            </nav>
        </div>
        
        <div class="main-content">
            <div class="header">
                <div>
                    <h1>Overdue Returns</h1>
                    <p style="color: #718096; margin-top: 5px;">Books and movies past their due date</p>
                </div>
                <div class="header-right">
                    <span id="currentDateTime"></span>
                    <button onclick="window.location.href='reports.html'" class="btn btn-secondary" style="margin-left: 15px;">
                        ‚Üê Back to Reports
                    </button>
                </div>
            </div>
            
            <!-- Overdue Summary -->
            <div class="summary-stats">
                <div class="stat-card summary-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-info">
                        <h3 id="totalOverdue">0</h3>
                        <p>Total Overdue Items</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3 id="membersWithOverdue">0</h3>
                        <p>Members with Overdue</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <h3 id="totalFineAmount">‚Çπ0</h3>
                        <p>Total Fine Amount</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-info">
                        <h3 id="maxOverdue">0</h3>
                        <p>Max Days Overdue</p>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-group">
                    <label>üîç Search Member/Book</label>
                    <input type="text" id="searchInput" placeholder="Search by name, ID, book..." onkeyup="filterTable()">
                </div>
                <div class="filter-group">
                    <label>üìÖ Overdue Range</label>
                    <select id="overdueRange" onchange="filterTable()">
                        <option value="all">All Overdue</option>
                        <option value="1-7">1-7 days</option>
                        <option value="8-15">8-15 days</option>
                        <option value="16-30">16-30 days</option>
                        <option value="31+">31+ days</option>
                    </select>
                </div>
                <button onclick="sendReminders()" class="btn btn-primary">
                    üìß Send Reminders
                </button>
                <button onclick="exportToCSV()" class="btn btn-secondary">
                    ‚¨áÔ∏è Export CSV
                </button>
            </div>
            
            <!-- Overdue Items Table -->
            <div class="card">
                <div class="card-header">
                    <h2>‚ö†Ô∏è Overdue Items</h2>
                    <span id="overdueCount" style="color: #e53e3e; font-weight: 600;">Loading...</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="issues-table" id="overdueTable">
                            <thead>
                                <tr>
                                    <th>Serial No</th>
                                    <th>Name of Book/Movie</th>
                                    <th>Type</th>
                                    <th>Membership ID</th>
                                    <th>Member Name</th>
                                    <th>Date of Issue</th>
                                    <th>Date of Return</th>
                                    <th>Days Overdue</th>
                                    <th>Fine Calculation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTableBody">
                                <tr>
                                    <td colspan="10" class="no-data">
                                        <i>‚ö†Ô∏è</i><br>
                                        Loading overdue items...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Fine Summary -->
                    <div id="fineSummary" class="fine-calculated" style="display: none;">
                        <div>
                            <strong style="font-size: 16px;">Total Fines to Collect:</strong>
                            <span id="totalFinesToCollect" style="color: #e53e3e; font-size: 24px; font-weight: 700; margin-left: 15px;">‚Çπ0</span>
                        </div>
                        <button onclick="collectAllFines()" class="btn-collect-fine">
                            Collect All Fines
                        </button>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <button onclick="changePage('prev')" id="prevBtn" disabled>Previous</button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button onclick="changePage('next')" id="nextBtn" disabled>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/frontend/js/auth.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/api';
        let overdueIssues = [];
        let filteredOverdue = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        const FINE_PER_DAY = 5;
        
        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const homeLink = document.getElementById('homeLink');
            const userRoleEl = document.getElementById('userRole');
            
            if (user.isAdmin || user.role === 'admin') {
                homeLink.href = 'admin-home.html';
                userRoleEl.textContent = 'Admin';
            } else {
                homeLink.href = 'user-home.html';
                userRoleEl.textContent = 'User';
            }
            
            loadOverdueReturns();
        });
        
        async function loadOverdueReturns() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/reports/overdue-returns`, {
                    headers: token ? { 'x-auth-token': token } : {}
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        document.getElementById('overdueTableBody').innerHTML = `
                            <tr><td colspan="10" class="no-data">
                                <i>üîí</i><br>
                                Please login to view active/overdue issues. <br>
                                <button onclick="window.location.href='admin-login.html'" class="btn btn-primary" style="margin-top:8px">Login</button>
                            </td></tr>`;
                        return;
                    }
                    const errText = await res.text().catch(()=>res.statusText||'Error');
                    document.getElementById('overdueTableBody').innerHTML = `
                        <tr><td colspan="10" class="no-data">
                            <i>‚ùå</i><br>
                            Error loading overdue items: ${res.status} ${errText}
                        </td></tr>`;
                    return;
                }

                overdueIssues = await res.json();
                filteredOverdue = [...overdueIssues];

                updateStatistics();
                filterTable();

            } catch (error) {
                console.error('Error loading overdue returns:', error);
                document.getElementById('overdueTableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="no-data">
                            <i>‚ùå</i><br>
                            Error loading overdue items. Please try again.
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateStatistics() {
            const total = overdueIssues.length;
            const uniqueMembers = new Set(overdueIssues.map(i => i.membershipId)).size;
            const totalFine = overdueIssues.reduce((sum, issue) => {
                const daysOverdue = issue.daysOverdue || calculateDaysOverdue(issue.returnDate);
                return sum + (daysOverdue * FINE_PER_DAY);
            }, 0);
            const maxOverdue = Math.max(...overdueIssues.map(i => i.daysOverdue || calculateDaysOverdue(i.returnDate)), 0);
            
            document.getElementById('totalOverdue').textContent = total;
            document.getElementById('membersWithOverdue').textContent = uniqueMembers;
            document.getElementById('totalFineAmount').textContent = `‚Çπ${totalFine}`;
            document.getElementById('maxOverdue').textContent = maxOverdue;
            
            document.getElementById('totalFinesToCollect').textContent = `‚Çπ${totalFine}`;
            document.getElementById('fineSummary').style.display = total > 0 ? 'flex' : 'none';
        }
        
        function calculateDaysOverdue(returnDate) {
            const today = new Date();
            const dueDate = new Date(returnDate);
            const diffTime = today - dueDate;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function calculateFine(daysOverdue) {
            return daysOverdue * FINE_PER_DAY;
        }
        
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rangeFilter = document.getElementById('overdueRange').value;
            
            filteredOverdue = overdueIssues.filter(issue => {
                const daysOverdue = issue.daysOverdue || calculateDaysOverdue(issue.returnDate);
                
                const matchesSearch = searchTerm === '' ||
                    issue.itemName?.toLowerCase().includes(searchTerm) ||
                    issue.memberName?.toLowerCase().includes(searchTerm) ||
                    issue.membershipId?.toLowerCase().includes(searchTerm) ||
                    issue.serialNo?.toLowerCase().includes(searchTerm);
                
                let matchesRange = true;
                if (rangeFilter !== 'all') {
                    if (rangeFilter === '1-7') matchesRange = daysOverdue >= 1 && daysOverdue <= 7;
                    else if (rangeFilter === '8-15') matchesRange = daysOverdue >= 8 && daysOverdue <= 15;
                    else if (rangeFilter === '16-30') matchesRange = daysOverdue >= 16 && daysOverdue <= 30;
                    else if (rangeFilter === '31+') matchesRange = daysOverdue >= 31;
                }
                
                return matchesSearch && matchesRange;
            });
            
            currentPage = 1;
            displayTable();
            updatePagination();
        }
        
        function displayTable() {
            const tableBody = document.getElementById('overdueTableBody');
            
            if (filteredOverdue.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="no-data">
                            <i>‚úÖ</i><br>
                            No overdue items found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredOverdue.slice(start, end);
            
            let html = '';
            
            pageData.forEach(issue => {
                const daysOverdue = issue.daysOverdue || calculateDaysOverdue(issue.returnDate);
                const fineAmount = calculateFine(daysOverdue);
                const issueDate = new Date(issue.issueDate).toLocaleDateString('en-IN');
                const returnDate = new Date(issue.returnDate).toLocaleDateString('en-IN');
                
                html += `
                    <tr class="overdue-highlight">
                        <td><span class="serial-no">${issue.serialNo || 'N/A'}</span></td>
                        <td><strong>${issue.itemName || 'N/A'}</strong></td>
                        <td>
                            <span style="background: ${issue.itemType === 'Book' ? '#c6f6d5' : '#fed7d7'}; 
                                         color: ${issue.itemType === 'Book' ? '#22543d' : '#742a2a'};
                                         padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                ${issue.itemType || 'N/A'}
                            </span>
                        </td>
                        <td><span class="member-id">${issue.membershipId || 'N/A'}</span></td>
                        <td>${issue.memberName || 'N/A'}</td>
                        <td>${issueDate}</td>
                        <td>${returnDate}</td>
                        <td>
                            <span class="days-overdue">${daysOverdue} days</span>
                        </td>
                        <td>
                            <span class="fine-amount">‚Çπ${fineAmount}</span>
                            <br>
                            <small style="color: #718096;">(‚Çπ5/day)</small>
                        </td>
                        <td>
                            <button onclick="returnAndPayFine('${issue.serialNo}', '${issue.membershipId}', ${fineAmount})" 
                                    class="btn-collect-fine btn-sm">
                                Collect Fine
                            </button>
                            <button onclick="viewMember('${issue.membershipId}')" 
                                    class="btn-view btn-sm" style="margin-left: 5px;">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('overdueCount').textContent = 
                `Showing ${start + 1}-${Math.min(end, filteredOverdue.length)} of ${filteredOverdue.length} overdue items`;
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredOverdue.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(filteredOverdue.length / itemsPerPage);
            if (direction === 'prev' && currentPage > 1) currentPage--;
            if (direction === 'next' && currentPage < totalPages) currentPage++;
            displayTable();
            updatePagination();
        }
        
        function returnAndPayFine(serialNo, membershipId, fineAmount) {
            sessionStorage.setItem('returnSerialNo', serialNo);
            sessionStorage.setItem('returnMembershipId', membershipId);
            sessionStorage.setItem('fineAmount', fineAmount);
            window.location.href = 'pay-fine.html';
        }
        
        function viewMember(membershipId) {
            sessionStorage.setItem('viewMembershipId', membershipId);
            window.location.href = 'member-details.html';
        }
        
        function sendReminders() {
            if (filteredOverdue.length === 0) {
                alert('No overdue items to send reminders for');
                return;
            }
            
            alert(`üìß Reminders sent to ${new Set(filteredOverdue.map(i => i.membershipId)).size} members with overdue items`);
        }
        
        function collectAllFines() {
            const totalFine = filteredOverdue.reduce((sum, issue) => {
                const daysOverdue = issue.daysOverdue || calculateDaysOverdue(issue.returnDate);
                return sum + (daysOverdue * FINE_PER_DAY);
            }, 0);
            
            if (confirm(`Collect total fine of ‚Çπ${totalFine} from all overdue members?`)) {
                alert('Fine collection processed successfully!');
                loadOverdueReturns();
            }
        }
        
        function exportToCSV() {
            if (filteredOverdue.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Serial No,Item Name,Type,Membership ID,Member Name,Issue Date,Due Date,Days Overdue,Fine Amount\n';
            
            filteredOverdue.forEach(issue => {
                const daysOverdue = issue.daysOverdue || calculateDaysOverdue(issue.returnDate);
                const fineAmount = calculateFine(daysOverdue);
                const issueDate = new Date(issue.issueDate).toLocaleDateString();
                const returnDate = new Date(issue.returnDate).toLocaleDateString();
                
                csv += `"${issue.serialNo}","${issue.itemName}","${issue.itemType}","${issue.membershipId}","${issue.memberName}","${issueDate}","${returnDate}",${daysOverdue},${fineAmount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `overdue_returns_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>